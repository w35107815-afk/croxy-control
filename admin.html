<h2>CroxyProxy 管理画面</h2>

<p>GitHub Token:</p>
<input id="token" style="width:400px">

<p>deviceId（空ならGLOBAL）:</p>
<input id="device">

<br><br>

<button onclick="setProxy(true)">ON</button>
<button onclick="setProxy(false)">OFF</button>

<pre id="log"></pre>

<script>

const owner="あなたのGitHub名";
const repo="croxy-control";
const tokenInput=()=>document.getElementById("token").value.trim();

async function loadDevices(){

 const headers={
   Authorization:"Bearer "+tokenInput(),
   Accept:"application/vnd.github+json"
 };

 let r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/devices.json`,{headers});
 let j=await r.json();
 let list=JSON.parse(atob(j.content));

 let html="";

 for(let id in list){
   html+=`
   <div>
     ${id}
     <button onclick="setDevice('${id}',true)">ON</button>
     <button onclick="setDevice('${id}',false)">OFF</button>
   </div>`;
 }

 document.getElementById("devices").innerHTML=html;
}

async function setDevice(id,state){

 const headers={
   Authorization:"Bearer "+tokenInput(),
   Accept:"application/vnd.github+json"
 };

 let r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/control.json`,{headers});
 let j=await r.json();
 let data=JSON.parse(atob(j.content));

 data.devices[id]=state;

 let updated=btoa(JSON.stringify(data,null,2));

 await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/control.json`,{
   method:"PUT",
   headers,
   body:JSON.stringify({
     message:"update device",
     content:updated,
     sha:j.sha
   })
 });

 alert("更新しました");
}

</script>

<div id="devices"></div>
<button onclick="loadDevices()">端末一覧読み込み</button>

