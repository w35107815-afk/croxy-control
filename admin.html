<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Croxy Control Panel</title>
<style>
body{font-family:sans-serif;max-width:700px;margin:40px auto}
.row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #ddd}
button{padding:6px 12px}
.save{margin-top:20px;font-size:16px;padding:10px 20px}
input{width:100%;padding:8px;margin:10px 0}
</style>
</head>
<body>

<h2>CroxyProxy 管理画面（自動保存版）</h2>

GitHub Token:
<input id="token" placeholder="ghp_xxxxx">

<div id="list">読み込み中...</div>

<button class="save" onclick="save()">保存（即反映）</button>

<script>
const USER="w35107815-afk";
const REPO="croxy-control";
const FILE="control.json";

let sha="";
let data={devices:{}};

async function load(){

 const res=await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${FILE}`);
 const json=await res.json();

 sha=json.sha;
 data=JSON.parse(atob(json.content));

 const list=document.getElementById("list");
 list.innerHTML="";

 Object.keys(data.devices).forEach(id=>{

   const row=document.createElement("div");
   row.className="row";

   const label=document.createElement("span");
   label.textContent=id;

   const btn=document.createElement("button");
   btn.textContent=data.devices[id]?"ON":"OFF";

   btn.onclick=()=>{
     data.devices[id]=!data.devices[id];
     btn.textContent=data.devices[id]?"ON":"OFF";
   };

   row.appendChild(label);
   row.appendChild(btn);
   list.appendChild(row);
 });

}

async function save(){

 const token=document.getElementById("token").value.trim();
 if(!token){ alert("Token入れてください"); return; }

 const content=btoa(JSON.stringify(data,null,2));

 const res=await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${FILE}`,{
   method:"PUT",
   headers:{
     "Authorization":"token "+token,
     "Content-Type":"application/json"
   },
   body:JSON.stringify({
     message:"update control",
     content:content,
     sha:sha
   })
 });

 if(res.ok){
   alert("保存成功！数秒で反映されます");
   load();
 }else{
   alert("保存失敗（Tokenか権限を確認）");
 }

}

load();
 // register.jsonも読む
try{
 const r=await fetch("./register.json?t="+Date.now());
 const reg=await r.json();

 reg.requests.forEach(id=>{
   if(!data.devices[id]){
     data.devices[id]=false;
   }
 });

}catch(e){}

</script>

</body>
</html>
