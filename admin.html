<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Croxy Control Panel</title>

<style>
body{
  font-family:sans-serif;
  background:#f6f8fb;
  margin:0;
  padding:30px;
}
.panel{
  background:white;
  max-width:900px;
  margin:auto;
  padding:25px;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  background:#f9fafb;
  border-radius:10px;
  margin-bottom:8px;
}
button{
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
.on{background:#16a34a;color:white}
.off{background:#dc2626;color:white}
.save{background:#2563eb;color:white;margin-top:15px}
input{
  width:100%;
  padding:8px;
  margin:10px 0;
}
</style>
</head>

<body>

<div class="panel">

<h2>CroxyProxy 管理画面</h2>

GitHub Token（保存時のみ必要）
<input id="token" placeholder="ghp_xxxxx">

<div id="list">読み込み中...</div>

<button class="save" onclick="save()">保存</button>

</div>

<script>

const CONTROL_URL="./control.json";
const API_URL="https://api.github.com/repos/w35107815-afk/croxy-control/contents/control.json";

let data={devices:{}};
let sha=null;

/* 読み込み */
async function load(){

  const list=document.getElementById("list");
  list.textContent="読み込み中...";

  try{

    const res=await fetch(CONTROL_URL+"?t="+Date.now());
    data=await res.json();

    const api=await fetch(API_URL);
    const file=await api.json();
    sha=file.sha;

    render();

  }catch(e){
    list.textContent="読み込み失敗";
    console.error(e);
  }
}

/* 描画 */
function render(){

  const list=document.getElementById("list");
  list.innerHTML="";

  Object.keys(data.devices).forEach(id=>{

    const row=document.createElement("div");
    row.className="row";

    const label=document.createElement("span");
    label.textContent=id;

    const btn=document.createElement("button");
    btn.textContent=data.devices[id]?"ON":"OFF";
    btn.className=data.devices[id]?"on":"off";

    btn.onclick=()=>{
      data.devices[id]=!data.devices[id];
      render();
    };

    row.appendChild(label);
    row.appendChild(btn);
    list.appendChild(row);
  });
}

/* 保存 */
async function save(){

  const token=document.getElementById("token").value.trim();
  if(!token){
    alert("Tokenを入力してください");
    return;
  }

  try{

    await fetch(API_URL,{
      method:"PUT",
      headers:{
        "Authorization":"token "+token,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        message:"update control",
        content:btoa(JSON.stringify(data,null,2)),
        sha:sha
      })
    });

    alert("保存成功（数秒で拡張に反映）");
    load();

  }catch(e){
    alert("保存失敗");
    console.error(e);
  }
}

load();

</script>

</body>
</html>
