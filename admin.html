<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Croxy Control Panel</title>
<style>
body{font-family:sans-serif;max-width:700px;margin:40px auto}
.row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #ddd}
button{padding:6px 12px}
.save{margin-top:20px;font-size:16px;padding:10px 20px}
input{width:100%;padding:8px;margin:10px 0}
</style>
</head>
<body>

<h2>CroxyProxy 管理画面（自動保存版）</h2>

GitHub Token:
<input id="token" placeholder="ghp_xxxxx">

<div id="list">読み込み中...</div>

<button class="save" onclick="save()">保存（即反映）</button>

<script>

const CONTROL_URL="./control.json";
const REGISTER_URL="./register.json";
let data={devices:{}};

async function load(){

  const list=document.getElementById("list");
  list.textContent="読み込み中...";

  try{

    const res=await fetch(CONTROL_URL+"?t="+Date.now());
    if(!res.ok) throw new Error("control.json fetch失敗");
    data=await res.json();

    try{
      const r=await fetch(REGISTER_URL+"?t="+Date.now());
      if(r.ok){
        const reg=await r.json();
        if(reg.requests){
          reg.requests.forEach(id=>{
            if(!data.devices[id]){
              data.devices[id]=false;
            }
          });
        }
      }
    }catch(e){
      console.warn("register.json skip");
    }

    list.innerHTML="";

    Object.keys(data.devices).forEach(id=>{
      const row=document.createElement("div");
      row.className="row";

      const label=document.createElement("span");
      label.textContent=id;

      const btn=document.createElement("button");
      btn.textContent=data.devices[id]?"ON":"OFF";

      btn.onclick=()=>{
        data.devices[id]=!data.devices[id];
        btn.textContent=data.devices[id]?"ON":"OFF";
      };

      row.appendChild(label);
      row.appendChild(btn);
      list.appendChild(row);
    });

  }catch(e){
    list.textContent="読み込み失敗（control.json確認）";
    console.error(e);
  }
}

load();

</script>

</body>
</html>

